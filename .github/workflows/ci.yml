# .github/workflows/ci.yml
# APEX TECHNICAL AUTHORITY STANDARD (DECEMBER 2025 EDITION)

name: 'CI: Build, Lint, and Test'

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: # Allows manual triggering

# Ensures that only one workflow run is executed for a given PR or branch at a time.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-verify:
    name: 'Build & Verify'
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: '1. Checkout Repository'
        uses: actions/checkout@v4

      - name: '2. Setup Node.js Environment (v20)'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: '3. Install Dependencies'
        run: npm install

      - name: '4. Lint & Format Check (Biome)'
        run: npm run lint:check
        # In package.json: "lint:check": "npx @biomejs/biome check ./src"

      - name: '5. Build Production Artifact'
        run: npm run build
        # In package.json: "build": "vite build"

      - name: '6. Run Unit & Integration Tests (Vitest)'
        run: npm run test:ci
        # In package.json: "test:ci": "vitest run --coverage"

      - name: '7. Upload Test Coverage to Codecov'
        uses: codecov/codecov-action@v4
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        with:
          slug: chirag127/ComicNarrate-AI-Web-Comic-Dubber-Browser-Extension
          fail_ci_if_error: true
          verbose: true
